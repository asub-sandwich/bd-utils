#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 2 ]]; then
	echo "Usage: $0 <video.mov> <output_dir>" >&2
	exit 1
fi

video="$1"
rootout="$2"

if [[ $# -ge 3 ]]; then
	fps="$3"
else
	fps=3
fi

if [[ ! -f "$video" ]]; then
	echo "Error: input video not found: $video" >&2
	exit 1
fi

has_exiftool=0
if command -v exiftool >/dev/null 2>&1; then
	has_exiftool=1
fi

mkdir -p "$rootout"
stem="$(basename "${video%.*}")"
outdir="$rootout/$stem"
mkdir -p "$outdir"

ffmpeg -hide_banner -loglevel error \
	-i "$video" \
	-map_metadata 0 \
	-vf "fps=$fps" \
	-vsync 0 \
	-start_number 1 -q:v 1 \
	-color_range mpeg -colorspace bt709 -color_primaries bt709 -color_trc bt709 \
	-f image2 "$outdir/frame_%03d.jpg"

if [[ $has_exiftool -eq 1 ]]; then
	exiftool -quiet -overwrite_original \
		-ee \
		-TagsFromFile "$video" -all:all -unsafe -icc_profile \
		"$outdir"/frame_*.jpg >/dev/null || true
fi

echo "Frames written to $outdir"
if [[ $has_exiftool -eq 1 ]]; then
	echo "Metadata copied via exiftool where possible"
fi
